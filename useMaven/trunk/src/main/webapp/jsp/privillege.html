<script type="text/javascript">
$(function(){
	$('#roleId').combobox({
		onSelect:function(item){
			$('input[name=idList]').each(function(){
				$(this).removeAttr("checked");
			});
			var role = $('#roleId').combobox('getValue');
			var parents = $('#ma_gridTable1').treegrid('getRoots');
			$.each(parents,function(index,item){
				$('#ma_gridTable1').treegrid('expand',item.id);
			});
			$.ajax({
				url:'getMenusByRole.action?roleId='+role,
				type:'POST',
				dataType:'text',
				success:function(data){
					$('input[name=idList]').each(function(){
						var thisId = $(this).val();
						if(data.indexOf(thisId+",")!=-1){
							$(this).attr("checked","true");
						}
					});
				}
			});
		}
	});
	$("#assignPriv").click(function(){
		var role = $('#roleId').combobox('getValue');
		if(role==""){
			$.messager.alert('错误！','请选择所要权限的角色！');
			return;
		}
		var rows = $('input:checked');
		if(rows.length<1){
			$.messager.alert("Error","请选好所要分配给该角色的菜单项！");
			return;
		}
		$.messager.confirm('提示','确定要把这些菜单项分配给该角色吗？',function(r){
			if(r){
				var idList = "";
				$.each(rows,function(){
					idList += $(this).val()+",";
				});
				$.post('setRolePriv.action',{roleId:role,idList:idList},afterAssign);
			}
		});
	});
});

function afterAssign(data){
	$.messager.alert("Success","权限分配成功！");
}
function showCheck(value,rowData,rowIndex){
	return "<input name='idList' type='checkbox' value='"+rowData.id+"'/>"+rowData.name;
}
</script>
<div class="easyui-layout"  data-options="fit : true,border : false">
<div data-options="region:'north',title:'选择角色',border:false,iconCls:'icon-columns'"
		style="height: 100px; background: #f4f4f4;padding:15px;">
请选择需要分配权限的角色：
<input id="roleId" name="user.roleId" class="easyui-combobox"
data-options="valueField:'id',textField:'name',url:'getAllRoles.action'"/>
<a id="assignPriv" class="easyui-linkbutton" data-options="iconCls:'icon-search'">分配权限</a>
</div>

<div data-options="region:'center',border:false">
    <table id="ma_gridTable1" title="菜单管理"  class="easyui-treegrid"  	   
            url="getMenuTree.action"
            fit="true" 
            fitColumns="true" 
            rownumbers="true" idField="id" treeField="name"  
            singleSelect="true">
    <thead>
    <tr>
    	<th field="name" 
    	formatter="showCheck" width="100px">菜单名称</th>
    	<th field="url" width="100px">url</th>
    	<th field="icon" width="100px">图标</th>
    	<th data-options="field:'showorder',width:20">显示顺序</th>
   	</tr>
     </thead>
    </table>
</div>
</div>